
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>MiniFood ‚Äì Pick your Lunch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonte moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wghtplay=swap
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2e7d32;
      color: #fff;
      text-align: center;
      padding: 16px;
      font-size: 1.5rem;
      font-weight: 600;
    }
    main {
      max-width: 900px;
      margin: 24px auto;
      padding: 0 16px;
    }
    h2 {
      margin-top: 24px;
      font-size: 1.3rem;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      padding: 16px;
      text-align: center;
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .card p {
      margin: 4px 0;
    }
    button {
      background: #2e7d32;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #256628;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
      align-items: center;
    }
    input[type="email"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 240px;
    }
    label {
      font-size: 0.9rem;
    }
    #cartList {
      list-style: none;
      padding: 0;
      margin: 12px 0;
    }
    #cartList li {
      background: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    #msg {
      margin-top: 12px;
      font-weight: 600;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>üçù MiniFood ‚Äî Pick your Lunch</header>
  <main>
    <div class="row">
      <button id="resetBtn">Reset Stock</button>
      <span style="font-size:0.85rem;color:#666;">Backend: <code id="apiUrl"></code></span>
    </div>

    <div id="meals" class="grid"></div>

    <h2>üõí Cart</h2>
    <ul id="cartList"></ul>
    <p><strong>Total:</strong> ‚Ç¨ <span id="cartTotal">0.00</span></p>

    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <label><input id="terms" type="checkbox" /> I accept the terms</label>
      <button id="checkoutBtn">Checkout</button>
    </div>

    <p id="msg"></p>
  </main>

  <script>
    const API = "https://demominifood.onrender.com";
    document.getElementById("apiUrl").textContent = API;

    const mealsDiv = document.getElementById("meals");
    const cartList = document.getElementById("cartList");
    const cartTotal = document.getElementById("cartTotal");
    const emailInput = document.getElementById("email");
    const termsInput = document.getElementById("terms");
    const msg = document.getElementById("msg");

    let meals = [];
    let cart = [];

    function showMessage(text, isError = false) {
      msg.textContent = text;
      msg.style.color = isError ? "crimson" : "#2e7d32";
      if (text) setTimeout(() => (msg.textContent = ""), 4000);
    }

    function renderMeals() {
      mealsDiv.innerHTML = "";
      meals.forEach(m => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${m.name}</h3>
          <p>‚Ç¨ ${m.price.toFixed(2)}</p>
          <p style="color:#666;font-size:0.85rem;">Stock: ${m.stock}</p>
          <button ${m.stock === 0 ? "disabled" : ""}>
            ${m.stock === 0 ? "Out of stock" : "Add"}
          </button>
        `;
        const btn = card.querySelector("button");
        btn.onclick = () => addToCart(m);
        mealsDiv.appendChild(card);
      });
    }

    function renderCart() {
      cartList.innerHTML = "";
      if (cart.length === 0) {
        cartList.innerHTML = "<li style='color:#666;'>(empty)</li>";
        cartTotal.textContent = "0.00";
        return;
      }
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${item.name} x${item.qty}</span>
          <button style="background:#e53935;">Remove</button>
        `;
        li.querySelector("button").onclick = () => removeFromCart(item.id);
        cartList.appendChild(li);
      });
      cartTotal.textContent = total.toFixed(2);
    }

    async function loadMeals() {
      const res = await fetch(API + "/api/meals");
      meals = await res.json();
      renderMeals();
    }

    async function addToCart(m) {
      try {
        const res = await fetch(API + "/api/cart", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mealId: m.id, qty: 1 })
        });
        const data = await res.json();
        if (!res.ok) throw data;

        const i = cart.findIndex(c => c.id === m.id);
        if (i >= 0) cart[i].qty += 1;
        else cart.push({ id: m.id, name: m.name, price: m.price, qty: 1 });
        renderCart();
        showMessage("Added!");
      } catch (e) {
        showMessage((e && (e.message || e.code)) || "Error", true);
      }
    }

    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      renderCart();
    }

    async function resetStock() {
      await fetch(API + "/api/admin/reset", { method: "POST" });
      cart = [];
      emailInput.value = "";
      termsInput.checked = false;
      await loadMeals();
      renderCart();
      showMessage("Stock reset.");
    }

    async function checkout() {
      if (!emailInput.value.includes("@")) {
        showMessage("Email is mandatory", true);
        return;
      }
      if (!termsInput.checked) {
        showMessage("Please accept the terms.", true);
        return;
      }

      const items = cart.map(c => ({ mealId: c.id, qty: c.qty }));
      try {
        const res = await fetch(API + "/api/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items,
            customer: { email: emailInput.value, acceptTerms: termsInput.checked }
          })
        });
        const data = await res.json();
        if (!res.ok) throw data;

        showMessage(`OK! Order ${data.orderId} total ‚Ç¨${data.total}`);
        cart = [];
        emailInput.value = "";
        termsInput.checked = false;
        await loadMeals();
        renderCart();
      } catch (e) {
        const m = e?.message || e?.code || "Checkout Failure";
        showMessage(m + (e?.path ? ` (${e.path})` : ""), true);
      }
    }

    document.getElementById("resetBtn").onclick = resetStock;
    document.getElementById("checkoutBtn").onclick = checkout;

    loadMeals();
    renderCart();
  </script>
</body>
</html>
