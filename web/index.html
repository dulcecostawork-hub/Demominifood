
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>MiniFood ‚Äì Pick your Lunch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  https://cdn.tailwindcss.com</script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Header -->
  <header class="bg-green-600 text-white p-4 text-center text-2xl font-bold shadow">
    üçù MiniFood ‚Äî Pick your Lunch
  </header>

  <main class="max-w-5xl mx-auto p-6">
    <!-- Backend Info -->
    <div class="flex items-center justify-between mb-4">
      <button id="resetBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
        Reset Stock
      </button>
      <span class="text-sm text-gray-500">Backend: <code id="apiUrl"></code></span>
    </div>

    <!-- Meals Grid -->
    <div id="meals" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

    <!-- Divider -->
    <hr class="my-6 border-gray-300" />

    <!-- Cart -->
    <section class="bg-white shadow rounded p-4">
      <h2 class="text-xl font-bold mb-4">üõí Cart</h2>
      <ul id="cartList" class="space-y-2 mb-4"></ul>
      <p class="font-semibold">Total: ‚Ç¨ <span id="cartTotal">0.00</span></p>
    </section>

    <!-- Checkout -->
    <div class="flex flex-wrap gap-4 mt-6">
      <input id="email" type="email" placeholder="Email" class="border rounded px-3 py-2 w-64" />
      <label class="flex items-center gap-2">
        <input id="terms" type="checkbox" /> I accept the terms
      </label>
      <button id="checkoutBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        Checkout
      </button>
    </div>

    <!-- Message -->
    <p id="msg" class="mt-4 font-semibold text-center"></p>
  </main>

  <script>
    const API = "https://demominifood.onrender.com";
    document.getElementById("apiUrl").textContent = API;

    const mealsDiv = document.getElementById("meals");
    const cartList = document.getElementById("cartList");
    const cartTotal = document.getElementById("cartTotal");
    const emailInput = document.getElementById("email");
    const termsInput = document.getElementById("terms");
    const msg = document.getElementById("msg");

    let meals = [];
    let cart = [];

    function showMessage(text, isError = false) {
      msg.textContent = text;
      msg.className = isError ? "text-red-600 font-bold mt-4" : "text-green-600 font-bold mt-4";
      if (text) setTimeout(() => (msg.textContent = ""), 4000);
    }

    function renderMeals() {
      mealsDiv.innerHTML = "";
      meals.forEach(m => {
        const card = document.createElement("div");
        card.className = "bg-white shadow rounded p-4 text-center hover:shadow-lg transition";
        card.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">${m.name}</h3>
          <p class="text-gray-700 mb-1">‚Ç¨ ${m.price.toFixed(2)}</p>
          <p class="text-sm text-gray-500 mb-3">Stock: ${m.stock}</p>
          <button ${m.stock === 0 ? "disabled" : ""}
            class="px-4 py-2 rounded text-white ${m.stock === 0 ? "bg-gray-400" : "bg-green-500 hover:bg-green-600"}">
            ${m.stock === 0 ? "Out of stock" : "Add"}
          </button>
        `;
        const btn = card.querySelector("button");
        btn.onclick = () => addToCart(m);
        mealsDiv.appendChild(card);
      });
    }

    function renderCart() {
      cartList.innerHTML = "";
      if (cart.length === 0) {
        cartList.innerHTML = "<li class='text-gray-500'>(empty)</li>";
        cartTotal.textContent = "0.00";
        return;
      }
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-gray-100 p-2 rounded";
        li.innerHTML = `
          <span>${item.name} x${item.qty}</span>
          <button class="text-red-500 hover:text-red-700">Remove</button>
        `;
        li.querySelector("button").onclick = () => removeFromCart(item.id);
        cartList.appendChild(li);
      });
      cartTotal.textContent = total.toFixed(2);
    }

    async function loadMeals() {
      const res = await fetch(API + "/api/meals");
      meals = await res.json();
      renderMeals();
    }

    async function addToCart(m) {
      try {
        const res = await fetch(API + "/api/cart", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mealId: m.id, qty: 1 })
        });
        const data = await res.json();
        if (!res.ok) throw data;

        const i = cart.findIndex(c => c.id === m.id);
        if (i >= 0) cart[i].qty += 1;
        else cart.push({ id: m.id, name: m.name, price: m.price, qty: 1 });
        renderCart();
        showMessage("Added!");
      } catch (e) {
        showMessage((e && (e.message || e.code)) || "Error", true);
      }
    }

    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      renderCart();
    }

    async function resetStock() {
      await fetch(API + "/api/admin/reset", { method: "POST" });
      cart = [];
      emailInput.value = "";
      termsInput.checked = false;
      await loadMeals();
      renderCart();
      showMessage("Stock reset.");
    }

    async function checkout() {
      if (!emailInput.value.includes("@")) {
        showMessage("Email is mandatory", true);
        return;
      }
      if (!termsInput.checked) {
        showMessage("Please accept the terms.", true);
        return;
      }

      const items = cart.map(c => ({ mealId: c.id, qty: c.qty }));
      try {
        const res = await fetch(API + "/api/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            items,
            customer: { email: emailInput.value, acceptTerms: termsInput.checked }
          })
        });
        const data = await res.json();
        if (!res.ok) throw data;

        showMessage(`OK! Order ${data.orderId} total ‚Ç¨${data.total}`);
        cart = [];
        emailInput.value = "";
        termsInput.checked = false;
        await loadMeals();
        renderCart();
      } catch (e) {
        const m = e?.message || e?.code || "Checkout Failure";
        showMessage(m + (e?.path ? ` (${e.path})` : ""), true);
      }
    }

    document.getElementById("resetBtn").onclick = resetStock;
    document.getElementById("checkoutBtn").onclick = checkout;

    loadMeals();
    renderCart();
  </script>
</body>
</html>
